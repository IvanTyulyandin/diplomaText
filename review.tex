\section{Обзор}
В этой главе будут рассмотрены среды исполнения и языки смарт-контрактов, а так же некоторые особенности \name{Hyperledger Iroha}.

\subsection{Языки и среды исполнения смарт-контрактов}
В 1997 году Ник Сабо (Nick Szabo) предложил концепцию смарт-контрактов~\cite{Szabo_SC}.
Смарт-контракт --- это программа, которая описывает взаимодействие участников блокчейн-сети. 
При сравнении с традиционным бумажным контрактом, смарт-контракт имеет однозначную семантику и выполняется автоматически при достижении определенных условий.
Результат выполнения смарт-контракта легко подтверждается, так как он будет записан в историю транзакций блокчейна.
На сегодняшний день существует множество различных языков смарт-контрактов и блокчейнов, которые могут исполнять программы на этих языках.

Смарт-контракт всегда должен завершаться для продолжения работы блокчейн-сети.
Если язык смарт-контрактов Тьюринг-полный, то среда исполнения должна предоставлять механизм, который будет ограничивать тем или иным способом количество операций смарт-контракта.
В случае \name{Ethereum} каждая инструкция стоит определенное количество \emph{газа}, цена которого выражена во внутренней криптовалюте \name{Et\-he\-re\-um}.
В \name{Hyperledger Fabric} имеется ограничение на время выполнения кода смарт-контракта.
Для языка \name{Rholang}~\cite{Rholang}, основанном на \name{Rho-calculus}~\cite{RhoCalculus}, выставляется лимит по количеству применений правил редукции.

Далее будут рассмотрены несколько сред исполнения смарт-кон\-трак\-тов и языки, которые данные среды поддерживают.

\subsubsection{Языки смарт-контрактов}
В этом параграфе рассмотрены языки смарт-контрактов с учетом их парадигм и свойств, таких как Тьюринг-полнота, механизм ограничения выполнения смарт-контракта платформой, на которой смарт-контракт исполняется, и системы типов.

На данный момент существуют языки смарт-контрактов с различным уровнем абстракции. 
\emph{Низкоуровневые языки} (low-level) предназначены для непосредственного выполнения средой исполнения.
Многие концепции, такие как семантика, вычислительная модель, система ограничения выполнения и типизация часто описываются на этом уровне.
Примеры таких языков --- \name{EVM}~\cite{EthereumYellowPaper}, \name{Bitcoin Script}~\cite{BitcoinScript} и \name{Michelson}~\cite{Michelson}.
\emph{Высокоуровневые языки} (high-level), такие как \name{Solidity}~\cite{Solidity}, \name{Flint}~\cite{Flint} и \name{Liquidity}~\cite{liquidity},
упрощают процесс разработки смарт-контрактов за счет повышенной читаемости, наличия более абстрактных синтаксических конструкций и системы типов.
\emph{Промежуточные языки} (intermediate-level) смарт-контрактов являются своего рода компромиссом между высокоуровневыми и низкоуровневыми языками по степени абстракции.
Как правило, они спроектированы для упрощения формальной верификации или статического анализа исходного кода, с учетом вычислительной модели, системы типов, семантики и других формализмов.
\name{Scilla}~\cite{Scilla} является промежуточным языком смарт-контрактов.

В ходе обзора языков смарт-контрактов на конференцию SYRCoSE 2019 в соавторстве была написана
обзорная статья \emph{A Survey of Smart Contract Safety and Pro\-gram\-ming Languages}, которая принята к публикации в сборнике трудов ИСП РАН.
В приложении~\ref{appendixA} приведена сводная таблица по языкам смарт-кон\-трак\-тов и их свойствам из данной статьи.
В ней приведены следующие характеристики языков смарт-контрактов: название, уровень абстракции, текущее состояние разработки, проект, для которого язык предназначен, парадигма, способ ограничения выполнения смарт-контракта целевой платформой и Тьюринг-полнота соответственно.

Было выявлено, что \name{Ethereum} является наиболее популярной платформой для работы со смарт-контрактами.
Экосистема данного блокчейна развита: существует множество языков с различными подходами, сред разработки и статических анализаторов.
Аналогичной экосистемы нет ни у одного из всех рассмотренных блокчейнов.


\subsubsection{\name{Ethereum Virtual Machine}}
% https://habr.com/ru/post/340928/
\name{Ethereum Virtual Machine} (сокращенно \name{EVM}) --- Тьюринг-полная виртуальная стековая машина блокчейна \name{Ethereum}.
Смарт-контракты для этой платформы написаны на байткоде~\cite{EthereumYellowPaper}.
Под эту среду исполнения смарт-контрактов существует множество языков ~\cite{Bamboo, Flint, IELE, Logikon, Solidity, SolidityX, Vyper, LLL, Yul}, которые компилируются в байткод \name{EVM}.

Есть два участка памяти, куда \name{EVM} может записывать значения во время выполнения кода смарт-контракта --- \emph{memory} и \emph{storage}.
Memory является временным хранилищем данных, необходимым для записи промежуточных значений.
Размер машинного слова \name{EVM} 256 битов.
Можно провести аналогию, что memory для \name{EVM} --- это как оперативная память для компьютера.
Ячейки memory адресуются от 0 до $2^{256} - 1$ и содержат байт информации.
Storage представляет из себя хранилище пар вида ключ-значение, которые описывают текущее состояние переменных смарт-контракта.
В отличие от memory, данные storage записываются в блокчейн.
Размер storage равен $2^{256}$ ячеек, каждая из них хранит машинное слово.

Аккаунты в блокчейн сети \name{Ethereum} бывают двух видов: \emph{пользовательские} и \emph{контракты}.
Аккаунты-контракты содержат код, который может быть вызван пользовательским аккаунтом или кодом другого контракта.

Существует множество реализаций клиентов для работы с распределённой блокчейн сетью \name{Ethereum}, например \name{Geth}\footnote{https://geth.ethereum.org/} и \name{Aleth}\footnote{http://www.ethdocs.org/en/latest/ethereum-clients/cpp-ethereum/}.
Также есть проекты, которые используют только виртуальную машину \name{Ethereum} и её байт-код, таким проектом является \name{Hy\-per\-led\-ger Bur\-row}~\cite{HLBurrow}.

\subsubsection{Выбор среды исполнения}
Для интеграции в \name{Hyperledger Iroha} была выбрана среда исполнения смарт-кон\-трак\-тов из проекта \name{Hy\-per\-led\-ger Bur\-row}.	
Этот проект реализует приватный блокчейн с возможностью выполнения смарт-кон\-трак\-тов и написан на языке \name{Go}.
Ключевыми особенностями реализации являются алгоритм консенсуса \name{Ten\-der\-mint}~\cite{Tendermint}, наличие программного интерфейса для удаленного вызова процедур, возможность выставлять права доступа к данным и на выполнение операций внутри сети, а также виртуальная машина для смарт-контрактов.

Эта среда исполнения обладает следующими преимуществами: 1) выполнение смарт-контрактов, написанных на байт-коде \name{EVM}; 2) наличие программного интерфейса для взаимодействия; 3) проект поддерживается \name{Hy\-per\-led\-ger}; 4) есть примеры интеграции с проектами \name{Hy\-per\-led\-ger Fabric}~\cite{HLFabricEVM} и \name{Hyperledger Sawtooth}~\cite{HLSeth}.
Так как \name{Ethereum} де-факто является самой популярной платформой для работы со смарт-контрактами, программистам будет проще адаптироваться к разработке на \name{Hy\-per\-led\-ger Iro\-ha}.
Важную роль играет принадлежность к \name{Hy\-per\-led\-ger} --- при возникновении проблем и вопросов на этапе интеграции виртуальной машины можно обратиться к сообществу разработчиков указанных ранее проектов.

У виртуальной машины внутри есть доступ к участку памяти me\-mo\-ry, а для реализации операций над участком памяти storage необходимо обращаться к истории блокчейна.
Программный интерфейс для взаимодействия описывает все методы, которые нужны виртуальной машине, чтобы получать, добавлять и обновлять данные блокчейна.


\subsection{\name{Hyperledger Iroha}}
\name{Hyperledger Iroha}~\cite{iroha} --- это приватный блокчейн, обладающий функциональностью для управления активами и сущностями, вводимые пользователями.
В нем используется алгоритм консенсуса \name{YAC}~\cite{YAC}, который основан на решении задачи о византийских генералах.
Данный фреймворк для распределенных хранилищ ориентирован на использование на мобильных устройствах.
Проект написан на языке \name{C++} с использованием библиотек \name{Boost}\footnote{https://www.boost.org/}, \name{Protobuf}\footnote{https://developers.google.com/protocol-buffers/}, \name{GTest}\footnote{https://github.com/google/googletest} и множества других.
В качестве хранилища истории блокчейна сети используется локальная для каждого участника база данных \name{PostgreSQL}\footnote{https://www.postgresql.org/}.

Как и во многих блокчейн сетях, пользователи \name{Hyperledger Iroha} выполняют различные действия с помощью транзакций, которые формируются из набора специальных команд.
Используя их, участники могут пересылать активы и управлять правами доступа, например, создать новую сущность или передать право владением активом другому участнику.

Прежде чем принять транзакцию, всем участникам сети нужно подтвердить её корректность.
Есть два этапа валидации --- \emph{stateless} и \emph{sta\-te\-ful}.
Команды должны быть сформированы согласно определённым правилам.
Во время stateless валидации контролируется соответствие этим правилам.
Далее проводится stateful валидация. 
На этом этапе проверяется выполнимость отправленной транзакции, например, права доступа или наличие активов.
